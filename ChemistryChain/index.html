<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chemistry Reaction Chain</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #2d3047 0%, #1c1e2e 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            border: 2px solid #ff6b6b;
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            color: #4ecdc4;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 15px;
        }
        
        .game-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 1100px) {
            .game-container {
                grid-template-columns: 1fr;
            }
        }
        
        .reaction-chain-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            border: 2px solid #4ecdc4;
            min-height: 600px;
        }
        
        .reaction-pool-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            border: 2px solid #ffd166;
        }
        
        .panel-title {
            color: #4ecdc4;
            margin-bottom: 15px;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid;
            padding-bottom: 10px;
        }
        
        .reaction-chain-panel .panel-title {
            color: #4ecdc4;
            border-color: #4ecdc4;
        }
        
        .reaction-pool-panel .panel-title {
            color: #ffd166;
            border-color: #ffd166;
        }
        
        .chain-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
            min-height: 450px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            border: 2px dashed rgba(255, 255, 255, 0.1);
        }
        
        .chain-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-height: 100px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
        }

        .chain-step.empty:hover {
            border: 2px dashed #4ecdc4;
            background: rgba(78, 205, 196, 0.1);
        }
        
        .chain-step.empty {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            min-height: 100px;
        }
        
        .chain-step.valid {
            border-color: #06d6a0;
            background: rgba(6, 214, 160, 0.1);
        }
        
        .chain-step.invalid {
            border-color: #ef476f;
            background: rgba(239, 71, 111, 0.1);
        }
        
        .reaction-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            min-width: 250px;
            text-align: center;
            cursor: move;
            transition: all 0.3s ease;
            border: 2px solid #ffd166;
            user-select: none;
        }
        
        .reaction-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(255, 209, 102, 0.3);
        }
        
        .reaction-card.dragging {
            opacity: 0.5;
            box-shadow: 0 0 10px #ffd166;
        }

        .reaction-card.used {
            opacity: 0.4;
            cursor: not-allowed;
            border-style: dashed;
        }
        
        .reaction-equation {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .reaction-name {
            font-size: 1rem;
            margin-bottom: 10px;
            color: #ffd166;
        }
        
        .reaction-description {
            font-size: 0.85rem;
            opacity: 0.8;
            line-height: 1.4;
        }
        
        .reaction-pool {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .level-indicator, .moves-counter, .score-board {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px 25px;
            border-radius: 10px;
            flex-grow: 1;
            text-align: center;
            border: 2px solid #118ab2;
        }
        
        .level-value, .moves-value, .score-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #118ab2;
        }
        
        .action-panel {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }
        
        button {
            padding: 14px 24px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        
        #check-btn {
            background: linear-gradient(to right, #06d6a0, #05b888);
            color: white;
        }
        
        #check-btn:hover {
            background: linear-gradient(to right, #05b888, #049c73);
            transform: translateY(-3px);
        }
        
        #reset-btn {
            background: linear-gradient(to right, #ffd166, #ffc043);
            color: white;
        }
        
        #reset-btn:hover {
            background: linear-gradient(to right, #ffc043, #ffb030);
            transform: translateY(-3px);
        }
        
        #hint-btn {
            background: linear-gradient(to right, #118ab2, #0d7799);
            color: white;
        }
        
        #hint-btn:hover {
            background: linear-gradient(to right, #0d7799, #0a6380);
            transform: translateY(-3px);
        }
        
        #next-btn {
            background: linear-gradient(to right, #9d4edd, #7b2cbf);
            color: white;
            display: none;
        }
        
        #next-btn:hover {
            background: linear-gradient(to right, #7b2cbf, #5a189a);
            transform: translateY(-3px);
        }
        
        .target-compound {
            text-align: center;
            padding: 15px;
            background: rgba(239, 71, 111, 0.2);
            border-radius: 10px;
            margin-top: 15px;
            border: 2px solid #ef476f;
        }
        
        .target-title {
            color: #ef476f;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .target-formula {
            font-size: 2rem;
            font-weight: bold;
            color: #ffd166;
            margin-bottom: 5px;
        }
        
        .target-name {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }
        
        .target-description {
            font-size: 0.9rem;
            opacity: 0.9;
            line-height: 1.4;
        }
        
        .instructions {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-top: 30px;
            border-left: 5px solid #4ecdc4;
        }
        
        .instructions h3 {
            color: #4ecdc4;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .instructions ul {
            padding-left: 20px;
            margin-top: 10px;
        }
        
        .instructions li {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        .feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            border-radius: 15px;
            padding: 30px;
            width: 500px;
            max-width: 90%;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            border: 3px solid;
            display: none;
        }
        
        .feedback.success {
            border-color: #06d6a0;
        }
        
        .feedback.error {
            border-color: #ef476f;
        }
        
        .feedback.info {
            border-color: #118ab2;
        }
        
        .feedback-title {
            font-size: 1.8rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .success .feedback-title {
            color: #06d6a0;
        }
        
        .error .feedback-title {
            color: #ef476f;
        }
        
        .info .feedback-title {
            color: #118ab2;
        }
        
        .feedback-content {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        .feedback-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .feedback-btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            border: none;
        }
        
        .continue-btn {
            background: #06d6a0;
            color: white;
        }
        
        .close-btn {
            background: #ef476f;
            color: white;
        }
        
        .game-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 999;
            display: none;
        }
        
        .reaction-arrow {
            color: #ffd166;
            font-size: 1.5rem;
        }
        
        .compound {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            font-weight: bold;
            min-width: 80px;
            text-align: center;
            border: 2px solid;
            display: inline-block;
        }
        
        .chain-validation {
            margin-top: 10px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }
        
        .valid-icon {
            color: #06d6a0;
        }
        
        .invalid-icon {
            color: #ef476f;
        }
        
        .compound-start {
            color: #4ecdc4;
            border-color: #4ecdc4 !important;
        }
        
        .compound-intermediate {
            color: #ffd166;
            border-color: #ffd166 !important;
        }
        
        .compound-final {
            color: #ef476f;
            border-color: #ef476f !important;
        }
        
        .level-progress {
            margin-top: 15px;
            text-align: center;
        }
        
        .progress-bar {
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #06d6a0, #4ecdc4);
            border-radius: 5px;
            width: 0%;
            transition: width 0.5s ease;
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }
        
        .step-number {
            position: absolute;
            left: 10px;
            top: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .reaction-info {
            font-size: 0.9rem;
            margin-top: 5px;
            opacity: 0.9;
            color: #4ecdc4;
            font-weight: bold;
        }
        
        .chain-flow {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
            max-width: 90%;
        }

        .remove-reaction-btn {
            position: absolute;
            right: 10px;
            top: 10px;
            background: transparent !important;
            border: none !important;
            color: #ff6b6b !important;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: transform 0.2s ease;
            box-shadow: none !important;
        }

        .remove-reaction-btn:hover {
            transform: scale(1.1);
        }
        
    </style>
</head>
<body>
    <div class="game-overlay" id="game-overlay"></div>
    
    <div class="container">
        <header>
            <h1><i class="fas fa-link"></i> Chemistry Reaction Chain</h1>
            <p class="subtitle">Arrange chemical reactions in the correct sequence to create target compounds!</p>
            <div class="game-info">
                <div class="level-indicator">
                    <div>Level</div>
                    <div class="level-value" id="level">1</div>
                </div>
                <div class="moves-counter">
                    <div>Moves Used</div>
                    <div class="moves-value" id="moves">0</div>
                </div>
                <div class="score-board">
                    <div>Score</div>
                    <div class="score-value" id="score">0</div>
                </div>
            </div>
        </header>
        
        <div class="game-container">
            <div class="reaction-chain-panel">
                <h2 class="panel-title"><i class="fas fa-project-diagram"></i> Reaction Chain</h2>
                <p>Drag reactions from the pool to build your reaction chain:</p>
                
                <div class="target-compound">
                    <div class="target-title">
                        <i class="fas fa-bullseye"></i> Target Compound
                    </div>
                    <div class="target-formula" id="target-formula">NH₃</div>
                    <div class="target-name" id="target-name">Ammonia</div>
                    <div class="target-description" id="target-description"></div>
                </div>
                
                <div class="chain-container" id="chain-container"></div>
                
                <div class="action-panel">
                    <button id="check-btn">
                        <i class="fas fa-check-circle"></i> Check Chain
                    </button>
                    <button id="reset-btn">
                        <i class="fas fa-redo"></i> Reset Chain
                    </button>
                    <button id="next-btn" style="display: none;">
                        <i class="fas fa-forward"></i> Next Level
                    </button>
                </div>
            </div>
            
            <div class="reaction-pool-panel">
                <h2 class="panel-title"><i class="fas fa-vial"></i> Reaction Pool</h2>
                <p>Available reactions for this level:</p>
                
                <div class="reaction-pool" id="reaction-pool"></div>
                
                <div class="level-progress">
                    <div>Level Progress</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="instructions">
            <h3><i class="fas fa-info-circle"></i> How to Play</h3>
            <ul>
                <li><strong>Drag reactions</strong> from the pool to the chain area to build your sequence</li>
                <li><strong>Arrange reactions in the correct order</strong> so the **main product** of one reaction becomes a **reactant** for the next.</li>
                <li><strong>Start the chain</strong> by using compounds available in the "Starting Materials" list.</li>
                <li><strong>Check your chain</strong> to validate the synthesis pathway.</li>
            </ul>
        </div>
        
        <footer>
            <p>Chemistry Reaction Chain | Master chemical synthesis through sequential reactions</p>
            <p>Made with <i class="fas fa-flask" style="color:#4ecdc4;"></i> for chemistry strategists</p>
        </footer>
    </div>
    
    <div class="feedback success" id="success-feedback">
        <h2 class="feedback-title"><i class="fas fa-check-circle"></i> Success!</h2>
        <div class="feedback-content" id="success-content">Your reaction chain is correct!</div>
        <div class="feedback-buttons">
            <button class="feedback-btn continue-btn" id="continue-btn">Continue</button>
        </div>
    </div>
    
    <div class="feedback error" id="error-feedback">
        <h2 class="feedback-title"><i class="fas fa-times-circle"></i> Chain Error</h2>
        <div class="feedback-content" id="error-content">Your reaction chain has errors.</div>
        <div class="feedback-buttons">
            <button class="feedback-btn close-btn" id="close-error-btn">Try Again</button>
        </div>
    </div>
    
    <div class="feedback info" id="info-feedback">
        <h2 class="feedback-title"><i class="fas fa-info-circle"></i> Information</h2>
        <div class="feedback-content" id="info-content"></div>
        <div class="feedback-buttons">
            <button class="feedback-btn close-btn" id="close-info-btn">OK</button>
        </div>
    </div>

    <script>
        // Game data
        const gameData = {
            level: 1,
            maxLevel: 8,
            score: 0,
            moves: 0,
            chain: [], // Array of reaction IDs
            reactionPool: [], // Array of available reaction IDs
            isChainValid: false,
            draggedReactionId: null
        };

        // Chemical compounds database
        const compounds = {
            "N₂": { name: "Nitrogen gas", color: "#4ecdc4" },
            "H₂": { name: "Hydrogen gas", color: "#ff6b6b" },
            "O₂": { name: "Oxygen gas", color: "#ffd166" },
            "NH₃": { name: "Ammonia", color: "#118ab2" },
            "H₂O": { name: "Water", color: "#06d6a0" },
            "NO": { name: "Nitric oxide", color: "#9d4edd" },
            "NO₂": { name: "Nitrogen dioxide", color: "#ef476f" },
            "HNO₃": { name: "Nitric acid", color: "#ff9e00" },
            "N₂O": { name: "Nitrous oxide", color: "#a663cc" },
            "N₂H₄": { name: "Hydrazine", color: "#38b000" },
            "CH₄": { name: "Methane", color: "#555555" },
            "CO₂": { name: "Carbon dioxide", color: "#6a994e" },
            "HCl": { name: "Hydrochloric acid", color: "#2d936c" },
            "NaCl": { name: "Sodium chloride", color: "#ffb4a2" },
            "NaOH": { name: "Sodium hydroxide", color: "#ffafcc" },
            "Cl₂": { name: "Chlorine gas", color: "#38b000" },
            "H₂O₂": { name: "Hydrogen peroxide", color: "#c77dff" }
        };

        // Reaction database - SIMPLIFIED (no stoichiometry, just compounds)
        const reactions = [
            { 
                id: "haber", 
                equation: "N₂ + 3H₂ → 2NH₃", 
                name: "Haber Process", 
                description: "Industrial synthesis of ammonia from nitrogen and hydrogen.",
                reactants: ["N₂", "H₂"], 
                products: ["NH₃"],
                level: 1 
            },
            { 
                id: "water_formation", 
                equation: "2H₂ + O₂ → 2H₂O", 
                name: "Water Formation", 
                description: "Combustion of hydrogen to form water.",
                reactants: ["H₂", "O₂"], 
                products: ["H₂O"],
                level: 1 
            },
            { 
                id: "nitric_oxide", 
                equation: "N₂ + O₂ → 2NO", 
                name: "Nitric Oxide Formation", 
                description: "Formation of nitric oxide at high temperatures.",
                reactants: ["N₂", "O₂"], 
                products: ["NO"],
                level: 2 
            },
            { 
                id: "nitrogen_dioxide", 
                equation: "2NO + O₂ → 2NO₂", 
                name: "Nitrogen Dioxide Formation", 
                description: "Oxidation of nitric oxide to nitrogen dioxide.",
                reactants: ["NO", "O₂"], 
                products: ["NO₂"],
                level: 2 
            },
            { 
                id: "nitric_acid", 
                equation: "3NO₂ + H₂O → 2HNO₃ + NO", 
                name: "Nitric Acid Production", 
                description: "Nitrogen dioxide reacts with water to form nitric acid.",
                reactants: ["NO₂", "H₂O"], 
                products: ["HNO₃", "NO"],
                level: 2 
            },
            { 
                id: "ostwald1", 
                equation: "4NH₃ + 5O₂ → 4NO + 6H₂O", 
                name: "Ostwald Process (Step 1)", 
                description: "Ammonia oxidation to nitric oxide.",
                reactants: ["NH₃", "O₂"], 
                products: ["NO", "H₂O"],
                level: 3 
            },
            { 
                id: "ostwald2", 
                equation: "2NO + O₂ → 2NO₂", 
                name: "Ostwald Process (Step 2)", 
                description: "Nitric oxide oxidation to nitrogen dioxide.",
                reactants: ["NO", "O₂"], 
                products: ["NO₂"],
                level: 3 
            },
            { 
                id: "ostwald3", 
                equation: "3NO₂ + H₂O → 2HNO₃ + NO", 
                name: "Ostwald Process (Step 3)", 
                description: "Nitrogen dioxide absorption in water.",
                reactants: ["NO₂", "H₂O"], 
                products: ["HNO₃", "NO"],
                level: 3 
            },
            { 
                id: "methane_combustion", 
                equation: "CH₄ + 2O₂ → CO₂ + 2H₂O", 
                name: "Methane Combustion", 
                description: "Complete combustion of methane.",
                reactants: ["CH₄", "O₂"], 
                products: ["CO₂", "H₂O"],
                level: 4 
            },
            { 
                id: "hydrochloric_acid", 
                equation: "H₂ + Cl₂ → 2HCl", 
                name: "Hydrogen Chloride Synthesis", 
                description: "Direct combination of hydrogen and chlorine.",
                reactants: ["H₂", "Cl₂"], 
                products: ["HCl"],
                level: 4 
            },
            { 
                id: "water_electrolysis", 
                equation: "2H₂O → 2H₂ + O₂", 
                name: "Water Electrolysis", 
                description: "Decomposition of water into hydrogen and oxygen.",
                reactants: ["H₂O"], 
                products: ["H₂", "O₂"],
                level: 5 
            },
            { 
                id: "ammonia_combustion", 
                equation: "4NH₃ + 3O₂ → 2N₂ + 6H₂O", 
                name: "Ammonia Combustion", 
                description: "Ammonia burns in oxygen to form nitrogen and water.",
                reactants: ["NH₃", "O₂"], 
                products: ["N₂", "H₂O"],
                level: 5 
            },
            { 
                id: "hydrazine_synthesis", 
                equation: "2NH₃ + H₂O₂ → N₂H₄ + 2H₂O", 
                name: "Hydrazine Synthesis", 
                description: "Reaction of ammonia with hydrogen peroxide.",
                reactants: ["NH₃", "H₂O₂"], 
                products: ["N₂H₄", "H₂O"],
                level: 6 
            },
            { 
                id: "chloralkali", 
                equation: "2NaCl + 2H₂O → 2NaOH + H₂ + Cl₂", 
                name: "Chloralkali Process", 
                description: "Electrolysis of brine to produce sodium hydroxide, hydrogen, and chlorine.",
                reactants: ["NaCl", "H₂O"], 
                products: ["NaOH", "H₂", "Cl₂"],
                level: 7 
            },
            { 
                id: "nitrous_oxide", 
                equation: "2NO + N₂H₄ → 2N₂O + 2H₂", 
                name: "Nitrous Oxide Synthesis", 
                description: "Reaction of nitric oxide with hydrazine.",
                reactants: ["NO", "N₂H₄"], 
                products: ["N₂O", "H₂"],
                level: 8 
            }
        ];

        // Game levels - SIMPLIFIED (no stoichiometry tracking)
        const levels = [
            { 
                level: 1, 
                title: "Ammonia Synthesis", 
                target: "NH₃", 
                startingMaterials: ["N₂", "H₂"],
                availableReactions: ["haber", "water_formation"], 
                chainLength: 1, 
                description: "Use the Haber process to synthesize ammonia from nitrogen and hydrogen.", 
                points: 100 
            },
            { 
                level: 2, 
                title: "Nitric Acid Pathway", 
                target: "HNO₃", 
                startingMaterials: ["N₂", "O₂", "H₂O"],
                availableReactions: ["nitric_oxide", "nitrogen_dioxide", "nitric_acid"], 
                chainLength: 3, 
                description: "Create nitric acid through a three-step process from nitrogen and oxygen.", 
                points: 300 
            },
            { 
                level: 3, 
                title: "Ostwald Process", 
                target: "HNO₃", 
                startingMaterials: ["NH₃", "O₂", "H₂O"],
                availableReactions: ["ostwald1", "ostwald2", "ostwald3"], 
                chainLength: 3, 
                description: "Industrial production of nitric acid from ammonia via the Ostwald process.", 
                points: 400 
            },
            { 
                level: 4, 
                title: "Hydrochloric Acid", 
                target: "HCl", 
                startingMaterials: ["H₂", "Cl₂"],
                availableReactions: ["hydrochloric_acid", "water_formation", "methane_combustion"], 
                chainLength: 1, 
                description: "Synthesize hydrochloric acid directly from hydrogen and chlorine.", 
                points: 150 
            },
            { 
                level: 5, 
                title: "Water Cycle", 
                target: "H₂", 
                startingMaterials: ["H₂O"],
                availableReactions: ["water_electrolysis", "water_formation", "ammonia_combustion"], 
                chainLength: 1, 
                description: "Produce hydrogen gas through water electrolysis.", 
                points: 200 
            },
            { 
                level: 6, 
                title: "Hydrazine Production", 
                target: "N₂H₄", 
                startingMaterials: ["NH₃", "H₂O₂"],
                availableReactions: ["hydrazine_synthesis", "water_formation", "ammonia_combustion"], 
                chainLength: 1, 
                description: "Synthesize hydrazine from ammonia and hydrogen peroxide.", 
                points: 250 
            },
            { 
                level: 7, 
                title: "Chloralkali Process", 
                target: "NaOH", 
                startingMaterials: ["NaCl", "H₂O"],
                availableReactions: ["chloralkali", "hydrochloric_acid", "water_formation"], 
                chainLength: 1, 
                description: "Produce sodium hydroxide through electrolysis of brine.", 
                points: 300 
            },
            { 
                level: 8, 
                title: "Nitrous Oxide", 
                target: "N₂O", 
                startingMaterials: ["NO", "N₂H₄"],
                availableReactions: ["nitrous_oxide", "water_electrolysis", "ammonia_combustion"], 
                chainLength: 1, 
                description: "Synthesize nitrous oxide from nitric oxide and hydrazine.", 
                points: 350 
            }
        ];

        // --- Utility Functions ---

        // Find a reaction by its ID
        function getReaction(id) {
            return reactions.find(r => r.id === id);
        }
        
        // Get compound display element
        function getCompoundHTML(compound, type) {
            const info = compounds[compound] || { name: compound, color: "#999" };
            const className = type ? `compound-${type}` : 'compound';
            return `<span class="${className}" title="${info.name}" style="border-color:${info.color}">${compound}</span>`;
        }

        // Renders the starting and current compounds for display
        function renderStartingCompounds(currentLevel) {
            const materialsHTML = currentLevel.startingMaterials.map(compound => {
                return getCompoundHTML(compound, 'start');
            }).join('<span class="chain-flow-arrow"> &nbsp;+&nbsp; </span>');

            document.getElementById('target-description').innerHTML = 
                `Start with: <div class="chain-flow">${materialsHTML}</div> ${currentLevel.description}`;
        }

        // Renders a single reaction card in the pool
        function createReactionCard(reaction) {
            const card = document.createElement('div');
            card.className = 'reaction-card';
            card.id = `card-${reaction.id}`;
            card.setAttribute('draggable', true);
            card.setAttribute('data-id', reaction.id);

            const reactantsHTML = reaction.reactants.map(r => getCompoundHTML(r, 'intermediate')).join(' + ');
            const productsHTML = reaction.products.map(p => getCompoundHTML(p, 'intermediate')).join(' + ');

            card.innerHTML = `
                <div class="reaction-name">${reaction.name}</div>
                <div class="reaction-equation">${reactantsHTML} <i class="fas fa-arrow-right reaction-arrow"></i> ${productsHTML}</div>
                <div class="reaction-description">${reaction.description}</div>
            `;
            
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);
            return card;
        }

        // Renders the empty or filled chain step
        function renderChainStep(index, reactionId) {
            const step = document.createElement('div');
            step.className = 'chain-step';
            step.setAttribute('data-index', index);
            step.setAttribute('data-reaction-id', reactionId || '');
            
            // Add step number
            const stepNumber = document.createElement('div');
            stepNumber.className = 'step-number';
            stepNumber.textContent = index + 1;
            step.appendChild(stepNumber);

            if (!reactionId) {
                step.classList.add('empty');
                step.innerHTML += '<p>Drag a reaction here</p>';
            } else {
                const reaction = getReaction(reactionId);
                const reactantsHTML = reaction.reactants.map(r => getCompoundHTML(r, 'intermediate')).join(' <span class="reaction-arrow">+</span> ');
                const productsHTML = reaction.products.map(p => getCompoundHTML(p, 'intermediate')).join(' <span class="reaction-arrow">+</span> ');

                step.innerHTML += `
                    <div class="reaction-info">${reaction.name}</div>
                    <div class="chain-flow">
                        ${reactantsHTML}
                        <i class="fas fa-long-arrow-alt-right reaction-arrow"></i>
                        ${productsHTML}
                    </div>
                `;
                
                // Add a remove button
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-reaction-btn';
                removeBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                removeBtn.title = 'Remove Reaction';
                removeBtn.onclick = (e) => {
                    e.stopPropagation(); 
                    removeReactionFromChain(index);
                };
                step.appendChild(removeBtn);
            }
            
            step.addEventListener('dragover', handleDragOver);
            step.addEventListener('dragleave', handleDragLeave);
            step.addEventListener('drop', handleDrop);
            return step;
        }

        // Renders the entire chain area
        function renderChain() {
            const container = document.getElementById('chain-container');
            container.innerHTML = '';
            const currentLevel = levels[gameData.level - 1];

            // Render all steps for the target chain length
            for (let i = 0; i < currentLevel.chainLength; i++) {
                const reactionId = gameData.chain[i];
                container.appendChild(renderChainStep(i, reactionId));
            }

            // Update pool to reflect used cards
            updateReactionPoolDisplay();
        }

        // Renders the reaction cards in the pool
        function renderReactionPool() {
            const pool = document.getElementById('reaction-pool');
            pool.innerHTML = '';
            const currentLevel = levels[gameData.level - 1];
            
            // Filter reactions available for the current level
            gameData.reactionPool = reactions.filter(r => currentLevel.availableReactions.includes(r.id));
            
            gameData.reactionPool.forEach(reaction => {
                pool.appendChild(createReactionCard(reaction));
            });
            
            // Initial check to disable used cards
            updateReactionPoolDisplay();
        }

        // Disables/enables reaction cards based on whether they are in the chain
        function updateReactionPoolDisplay() {
            const chainIds = gameData.chain.filter(id => id);
            gameData.reactionPool.forEach(reaction => {
                const card = document.getElementById(`card-${reaction.id}`);
                if (card) {
                    const isUsed = chainIds.includes(reaction.id);
                    card.classList.toggle('used', isUsed);
                    card.setAttribute('draggable', !isUsed);
                }
            });
        }

        // Updates all score and display elements
        function updateDisplay() {
            const currentLevel = levels[gameData.level - 1];

            document.getElementById('level').textContent = gameData.level;
            document.getElementById('moves').textContent = gameData.moves;
            document.getElementById('score').textContent = gameData.score;
            document.getElementById('target-formula').textContent = currentLevel.target;
            document.getElementById('target-name').textContent = compounds[currentLevel.target]?.name || currentLevel.target;
            
            renderStartingCompounds(currentLevel);
            renderChain();
            // Note: renderReactionPool is only called in updateDisplay during initialization/level change

            // Progress Bar
            const progress = (gameData.level / gameData.maxLevel) * 100;
            document.getElementById('progress-fill').style.width = `${progress}%`;

            // Next button control
            document.getElementById('next-btn').style.display = gameData.isChainValid ? 'flex' : 'none';
        }

        // --- Game Logic (SIMPLIFIED VALIDATION) ---

        function checkChainValidity() {
            const currentLevel = levels[gameData.level - 1];
            const chain = gameData.chain.filter(id => id);

            // Check all steps are filled
            if (chain.length !== currentLevel.chainLength) {
                return { 
                    valid: false, 
                    message: `Please place all ${currentLevel.chainLength} reactions in the chain.` 
                };
            }

            // Check for duplicates
            const uniqueChain = [...new Set(chain)];
            if (uniqueChain.length !== chain.length) {
                return { 
                    valid: false, 
                    message: "Each reaction can only be used once in the chain." 
                };
            }

            // SIMPLIFIED VALIDATION LOGIC (from the fixed code)
            // Check step-by-step connectivity
            for (let i = 0; i < chain.length; i++) {
                const reaction = getReaction(chain[i]);
                
                // Check if first reaction uses starting materials
                if (i === 0) {
                    const usesStartingMaterial = reaction.reactants.some(reactant => 
                        currentLevel.startingMaterials.includes(reactant)
                    );
                    if (!usesStartingMaterial) {
                        return { 
                            valid: false, 
                            message: `Step 1 (${reaction.name}) doesn't use any of the starting materials: ${currentLevel.startingMaterials.join(", ")}` 
                        };
                    }
                }
                
                // Check if subsequent reactions use products from previous reactions
                if (i > 0) {
                    const prevReaction = getReaction(chain[i-1]);
                    const prevProducts = prevReaction.products;
                    const currReactants = reaction.reactants;
                    
                    // Check if at least one product from previous reaction is a reactant in current reaction
                    const hasConnection = prevProducts.some(product => 
                        currReactants.includes(product)
                    );
                    
                    if (!hasConnection) {
                        return { 
                            valid: false, 
                            message: `Step ${i+1} (${reaction.name}) doesn't use any product from Step ${i} (${prevReaction.name})` 
                        };
                    }
                }
            }

            // Check final product matches target
            const finalReaction = getReaction(chain[chain.length - 1]);
            if (!finalReaction.products.includes(currentLevel.target)) {
                return { 
                    valid: false, 
                    message: `The final reaction doesn't produce the target compound (${currentLevel.target})` 
                };
            }

            return { 
                valid: true, 
                message: `Perfect! Your reaction chain correctly produces ${currentLevel.target}!` 
            };
        }
        
        // Function to handle the actual validation and feedback
        function handleCheckChain() {
            if (gameData.chain.filter(id => id).length !== levels[gameData.level - 1].chainLength) {
                showFeedback('info', 'Information', `Please place all ${levels[gameData.level - 1].chainLength} reactions before checking the chain.`);
                return;
            }

            const result = checkChainValidity();
            gameData.moves++;

            if (result.valid) {
                gameData.isChainValid = true;
                const currentLevel = levels[gameData.level - 1];
                const pointsGained = currentLevel.points;
                gameData.score += pointsGained;

                showFeedback('success', 'Success!', `${result.message} You earned ${pointsGained} points!`);
            } else {
                gameData.isChainValid = false;
                showFeedback('error', 'Chain Error', result.message);
            }
            updateDisplay();
            highlightChainValidation(result.valid);
        }

        // Visually highlight the chain steps based on validity
        function highlightChainValidation(isValid) {
            const steps = document.querySelectorAll('.chain-step');
            steps.forEach(step => {
                step.classList.remove('valid', 'invalid');
                if (step.getAttribute('data-reaction-id')) {
                    if (isValid) {
                        step.classList.add('valid');
                    } else {
                        step.classList.add('invalid');
                    }
                }
            });
        }

        // Moves to the next level
        function nextLevel() {
            if (gameData.level < gameData.maxLevel) {
                gameData.level++;
                gameData.chain = [];
                gameData.isChainValid = false;
                gameData.moves = 0;
                hideAllFeedback();
                initializeLevel();
            } else {
                showFeedback('info', 'Congratulations!', 'You have completed all levels of the Chemistry Reaction Chain game!');
            }
        }
        
        // Resets the current level chain
        function resetChain() {
            gameData.chain = new Array(levels[gameData.level - 1].chainLength).fill(null);
            gameData.isChainValid = false;
            document.getElementById('next-btn').style.display = 'none';
            const steps = document.querySelectorAll('.chain-step');
            steps.forEach(step => step.classList.remove('valid', 'invalid'));
            hideAllFeedback();
            updateDisplay();
        }

        // Removes a reaction from the chain and puts it back in the pool
        function removeReactionFromChain(index) {
            gameData.chain[index] = null;
            gameData.isChainValid = false;
            document.getElementById('next-btn').style.display = 'none';
            updateDisplay();
        }

        // --- Drag and Drop Handlers ---

        function handleDragStart(e) {
            gameData.draggedReactionId = e.target.getAttribute('data-id');
            e.dataTransfer.setData('text/plain', gameData.draggedReactionId);
            e.target.classList.add('dragging');
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            gameData.draggedReactionId = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            const step = e.currentTarget;
            if (step.classList.contains('empty')) {
                step.style.borderColor = '#4ecdc4'; 
            }
        }

        function handleDragLeave(e) {
            const step = e.currentTarget;
            if (step.classList.contains('empty')) {
                step.style.borderColor = 'rgba(255, 255, 255, 0.3)';
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            const reactionId = e.dataTransfer.getData('text/plain');
            const step = e.currentTarget;
            const index = parseInt(step.getAttribute('data-index'));

            step.style.borderColor = '';

            if (reactionId) {
                // Check if the reaction is already used in the chain
                if (gameData.chain.includes(reactionId)) {
                    showFeedback('info', 'Reaction Used', 'This reaction is already placed in the chain.');
                    return;
                }
                
                // Add the reaction to the chain array
                gameData.chain[index] = reactionId;
                gameData.isChainValid = false;
                document.getElementById('next-btn').style.display = 'none';

                updateDisplay();
            }
        }

        // --- Feedback / Modal Functions ---
        
        function showFeedback(type, title, content) {
            const feedbackBox = document.getElementById(`${type}-feedback`);
            document.getElementById('game-overlay').style.display = 'block';
            feedbackBox.querySelector('.feedback-title').innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'times-circle' : 'info-circle'}"></i> ${title}`;
            feedbackBox.querySelector('.feedback-content').innerHTML = content;
            feedbackBox.style.display = 'block';
        }

        function hideAllFeedback() {
            document.getElementById('game-overlay').style.display = 'none';
            document.getElementById('success-feedback').style.display = 'none';
            document.getElementById('error-feedback').style.display = 'none';
            document.getElementById('info-feedback').style.display = 'none';
        }
        
        // --- Initialization ---

        function initializeLevel() {
            const currentLevel = levels[gameData.level - 1];
            gameData.chain = new Array(currentLevel.chainLength).fill(null);
            renderReactionPool();
            updateDisplay();
        }

        function initializeGame() {
            // Bind Buttons
            document.getElementById('check-btn').addEventListener('click', handleCheckChain);
            document.getElementById('reset-btn').addEventListener('click', resetChain);
            document.getElementById('next-btn').addEventListener('click', nextLevel);

            document.getElementById('continue-btn').addEventListener('click', nextLevel);
            document.getElementById('close-error-btn').addEventListener('click', hideAllFeedback);
            document.getElementById('close-info-btn').addEventListener('click', hideAllFeedback);
            document.getElementById('game-overlay').addEventListener('click', hideAllFeedback);

            initializeLevel();
        }

        // Start the game when the DOM is ready
        document.addEventListener('DOMContentLoaded', initializeGame);

    </script>
</body>
</html>