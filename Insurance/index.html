<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monster Insurance Defender</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Roboto:wght@400;700&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #87CEEB;
            font-family: 'Roboto', sans-serif;
            touch-action: manipulation;
        }

        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .hud-bar {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            font-family: 'Fredoka One', cursive;
            font-size: 22px;
            border-bottom: 4px solid #FFD700;
        }

        .hint-box {
            align-self: center;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 30px;
            border-radius: 15px;
            margin-top: 10px;
            border: 3px solid #333;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .formula { color: #d32f2f; font-size: 20px; font-weight: bold; }

        .spell-container {
            pointer-events: auto;
            background: rgba(0,0,0,0.6);
            padding: 20px;
            display: flex;
            justify-content: center;
            gap: 20px;
            padding-bottom: 40px;
        }

        .spell-btn {
            background: #fff;
            border: none;
            border-bottom: 6px solid #bbb;
            border-radius: 15px;
            padding: 15px;
            width: 140px;
            font-family: 'Fredoka One', cursive;
            font-size: 20px;
            cursor: pointer;
            transition: 0.1s;
        }

        .spell-btn:active { transform: translateY(4px); border-bottom-width: 2px; }

        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            color: white;
            text-align: center;
        }

        .hidden { display: none !important; }

        .panel {
            background: #fff; color: #333;
            padding: 30px; border-radius: 20px;
            max-width: 450px; border: 5px solid #4CAF50;
        }

        .big-btn {
            background: #4CAF50; color: white; border: none;
            padding: 15px 40px; font-size: 24px; border-radius: 50px;
            font-family: 'Fredoka One', cursive; cursor: pointer;
            margin-top: 20px; box-shadow: 0 6px 0 #2E7D32;
        }

        #lvl-banner {
            position: absolute; top: 40%; width: 100%;
            text-align: center; font-family: 'Fredoka One';
            font-size: 60px; color: #FFD700;
            text-shadow: 4px 4px #000;
            pointer-events: none;
            opacity: 0; transition: 0.5s;
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>
    <div id="lvl-banner">LEVEL UP!</div>

    <div id="ui-layer">
        <div class="hud-bar">
            <span>Level: <span id="lvl-txt">1</span></span>
            <span>Score: <span id="score">0</span></span>
            <span>Health: <span id="health">100</span>%</span>
        </div>

        <div class="hint-box">
            <div id="target-msg" style="font-weight: bold;">LEVEL 1: SLIME INVASION</div>
            <div class="formula" id="formula-txt">Payout = Loss - Deductible</div>
        </div>

        <div class="spell-container">
            <button class="spell-btn" id="btn1" onclick="checkAnswer(0)">-</button>
            <button class="spell-btn" id="btn2" onclick="checkAnswer(1)">-</button>
            <button class="spell-btn" id="btn3" onclick="checkAnswer(2)">-</button>
        </div>
    </div>

    <div id="startScreen" class="overlay">
        <div class="panel">
            <h1 style="color:#2E7D32">Monster Defender</h1>
            <p>Monsters are stealing the kingdom's gold!<br>Calculate the <b>Insurance Payout</b> to stop them.</p>
            <p>Reach 1000 score to hit Level 2!</p>
            <button class="big-btn" onclick="startGame()">DEFEND CASTLE</button>
        </div>
    </div>

    <div id="endScreen" class="overlay hidden">
        <div class="panel">
            <h1>CASTLE OVERRUN</h1>
            <p>Final Score: <span id="finalScore">0</span></p>
            <button class="big-btn" onclick="location.reload()">RESTART</button>
        </div>
    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let isPlaying = false, score = 0, health = 100, level = 1, enemies = [], spawnTimer = 0, currentOptions = [];

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize);
    resize();

    function startGame() {
        document.getElementById('startScreen').classList.add('hidden');
        isPlaying = true;
        spawnEnemy();
        requestAnimationFrame(gameLoop);
    }

    function gameLoop() {
        if (!isPlaying) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawScene();
        
        // Level Up Logic
        if (score >= 1000 && level === 1) levelUp(2, "LEVEL 2: CO-INSURANCE", "Payout = (Loss - Ded) x 80%");
        if (score >= 2500 && level === 2) levelUp(3, "LEVEL 3: CHAOS MODE", "Formulas are Random!");

        spawnTimer++;
        let rate = level === 1 ? 150 : (level === 2 ? 120 : 90);
        if (spawnTimer > rate) { spawnEnemy(); spawnTimer = 0; }

        updateEnemies();
        requestAnimationFrame(gameLoop);
    }

    function levelUp(newLvl, title, formula) {
        level = newLvl;
        document.getElementById('lvl-txt').innerText = level;
        document.getElementById('target-msg').innerText = title;
        document.getElementById('formula-txt').innerText = formula;
        
        let banner = document.getElementById('lvl-banner');
        banner.style.opacity = "1";
        setTimeout(() => banner.style.opacity = "0", 2000);
    }

    function spawnEnemy() {
        let loss = (Math.floor(Math.random() * 6) + 2) * 500;
        let ded = 500;
        let ans, type = level;
        
        if (level === 3) type = Math.random() > 0.5 ? 1 : 2;

        if (type === 1) ans = loss - ded;
        else ans = (loss - ded) * 0.8;

        enemies.push({
            x: canvas.width + 100,
            y: canvas.height - 180,
            loss, ded, ans, type,
            speed: 1 + (level * 0.5),
            color: type === 1 ? "#4CAF50" : "#9C27B0",
            wiggle: 0
        });
        if (enemies.length === 1) updateButtons();
    }

    function updateEnemies() {
        for (let i = enemies.length - 1; i >= 0; i--) {
            let e = enemies[i];
            e.x -= e.speed;
            e.wiggle += 0.1;

            drawMonster(e, i === 0);

            if (e.x < 150) {
                health -= 20;
                enemies.splice(i, 1);
                document.getElementById('health').innerText = health;
                if (enemies.length > 0) updateButtons();
                if (health <= 0) endGame();
            }
        }
    }

    function drawMonster(e, isTarget) {
        ctx.save();
        ctx.translate(e.x, e.y);
        let s = Math.sin(e.wiggle) * 5;

        // Body
        ctx.fillStyle = e.color;
        ctx.beginPath();
        ctx.moveTo(-40, 40);
        ctx.quadraticCurveTo(-50, -40 + s, 0, -50 + s);
        ctx.quadraticCurveTo(50, -40 + s, 40, 40);
        ctx.fill();

        // Horns
        ctx.beginPath();
        ctx.moveTo(-20, -45 + s); ctx.lineTo(-30, -70 + s); ctx.lineTo(-10, -45 + s);
        ctx.moveTo(20, -45 + s); ctx.lineTo(30, -70 + s); ctx.lineTo(10, -45 + s);
        ctx.fill();

        // Eyes
        ctx.fillStyle = "white";
        ctx.beginPath(); ctx.arc(-15, -10 + s, 10, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(15, -10 + s, 10, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "black";
        ctx.beginPath(); ctx.arc(-15, -10 + s, 4, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(15, -10 + s, 4, 0, Math.PI*2); ctx.fill();

        // Target Ring
        if (isTarget) {
            ctx.strokeStyle = "red"; ctx.lineWidth = 4;
            ctx.beginPath(); ctx.arc(0, 0, 60, 0, Math.PI*2); ctx.stroke();
        }

        // Info Bubble
        ctx.fillStyle = "white";
        ctx.fillRect(-60, -130 + s, 120, 50);
        ctx.strokeStyle = "#333"; ctx.strokeRect(-60, -130 + s, 120, 50);
        ctx.fillStyle = "black"; ctx.font = "bold 14px Arial"; ctx.textAlign = "center";
        ctx.fillText("Loss: RM" + e.loss, 0, -112 + s);
        ctx.fillText("Ded: RM" + e.ded, 0, -95 + s);
        
        ctx.restore();
    }

    function updateButtons() {
        if (enemies.length === 0) return;
        let correct = enemies[0].ans;
        currentOptions = [correct, correct + 200, correct - 300].sort(() => Math.random() - 0.5);
        for (let i = 0; i < 3; i++) {
            document.getElementById('btn' + (i+1)).innerText = "RM " + currentOptions[i];
        }
    }

    function checkAnswer(idx) {
        if (enemies.length > 0 && currentOptions[idx] === enemies[0].ans) {
            score += 200;
            enemies.shift();
            document.getElementById('score').innerText = score;
            updateButtons();
        } else {
            score = Math.max(0, score - 100);
            document.getElementById('score').innerText = score;
        }
    }

    function drawScene() {
        ctx.fillStyle = "#4CAF50"; ctx.fillRect(0, canvas.height - 100, canvas.width, 100);
        ctx.fillStyle = "#795548"; ctx.fillRect(0, canvas.height - 130, canvas.width, 30);
        // Castle
        ctx.fillStyle = "#607D8B"; ctx.fillRect(30, canvas.height - 300, 120, 200);
        ctx.fillStyle = "#455A64"; ctx.fillRect(20, canvas.height - 320, 140, 30);
    }

    function endGame() {
        isPlaying = false;
        document.getElementById('endScreen').classList.remove('hidden');
        document.getElementById('finalScore').innerText = score;
    }
</script>
</body>
</html>