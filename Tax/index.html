<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taxation Challenge - Consumer Mathematics</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #2a4b8c);
            color: #333;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .game-container {
            width: 100%;
            max-width: 900px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .game-header {
            background: linear-gradient(to right, #2c3e50, #3498db);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .game-title {
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .game-title span {
            color: #f1c40f;
        }
        
        .stats-container {
            display: flex;
            gap: 25px;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        #timer {
            color: #f1c40f;
        }
        
        #score {
            color: #2ecc71;
        }
        
        #level {
            color: #9b59b6;
        }
        
        .stars-container {
            display: flex;
            gap: 5px;
        }
        
        .star {
            color: #ccc;
            font-size: 1.2rem;
        }
        
        .star.filled {
            color: #f1c40f;
        }
        
        .game-content {
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .game-scenario {
            background-color: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            border-left: 5px solid #3498db;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .scenario-title {
            font-size: 1.3rem;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .scenario-text {
            line-height: 1.6;
            color: #555;
        }
        
        .tax-info {
            background-color: #e8f4fc;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border: 1px dashed #3498db;
        }
        
        .formula-box {
            background-color: #fff8e1;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border: 1px dashed #ff9800;
        }
        
        .formula-title {
            color: #e65100;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .formula-content {
            color: #555;
            line-height: 1.6;
        }
        
        .hint-box {
            background-color: #e8f5e9;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border: 1px dashed #4caf50;
            display: none;
        }
        
        .hint-title {
            color: #2e7d32;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .hint-content {
            color: #555;
            line-height: 1.6;
        }
        
        .game-challenge {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 10px;
        }
        
        .challenge-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .challenge-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.12);
        }
        
        .challenge-card.correct {
            border-color: #2ecc71;
        }
        
        .challenge-card.incorrect {
            border-color: #e74c3c;
        }
        
        .challenge-card.selected {
            border-color: #3498db;
            background-color: #f0f8ff;
        }
        
        .challenge-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .challenge-title {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .challenge-description {
            color: #666;
            line-height: 1.5;
        }
        
        .input-container {
            margin-top: 20px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        label {
            font-weight: 600;
            color: #2c3e50;
        }
        
        input {
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1.1rem;
            transition: border-color 0.3s;
        }
        
        input:focus {
            border-color: #3498db;
            outline: none;
        }
        
        .buttons-container {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .game-button {
            padding: 14px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            justify-content: center;
            min-width: 180px;
        }
        
        #submitBtn {
            background: linear-gradient(to right, #2ecc71, #27ae60);
            color: white;
        }
        
        #submitBtn:hover {
            background: linear-gradient(to right, #27ae60, #219653);
            transform: scale(1.05);
        }
        
        #hintBtn {
            background: linear-gradient(to right, #ff9800, #f57c00);
            color: white;
        }
        
        #hintBtn:hover {
            background: linear-gradient(to right, #f57c00, #ef6c00);
            transform: scale(1.05);
        }
        
        #nextBtn {
            background: linear-gradient(to right, #3498db, #2980b9);
            color: white;
        }
        
        #nextBtn:hover {
            background: linear-gradient(to right, #2980b9, #1c6ea4);
            transform: scale(1.05);
        }
        
        #restartBtn {
            background: linear-gradient(to right, #e74c3c, #c0392b);
            color: white;
        }
        
        #restartBtn:hover {
            background: linear-gradient(to right, #c0392b, #a93226);
            transform: scale(1.05);
        }
        
        .feedback {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-weight: 600;
            display: none;
        }
        
        .feedback.correct {
            background-color: rgba(46, 204, 113, 0.2);
            color: #27ae60;
            border: 1px solid #2ecc71;
            display: block;
        }
        
        .feedback.incorrect {
            background-color: rgba(231, 76, 60, 0.2);
            color: #c0392b;
            border: 1px solid #e74c3c;
            display: block;
        }
        
        .game-over {
            text-align: center;
            padding: 40px 20px;
            display: none;
        }
        
        .game-over h2 {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        .final-score {
            font-size: 3rem;
            color: #9b59b6;
            font-weight: 800;
            margin: 20px 0;
        }
        
        .final-stars {
            font-size: 3rem;
            margin: 25px 0;
            letter-spacing: 15px;
        }
        
        .final-message {
            font-size: 1.3rem;
            color: #555;
            margin-top: 20px;
            line-height: 1.6;
        }
        
        .level-progress {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .level-star {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .level-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .game-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .stats-container {
                width: 100%;
                justify-content: space-between;
            }
            
            .game-challenge {
                grid-template-columns: 1fr;
            }
            
            .buttons-container {
                flex-direction: column;
            }
            
            .game-button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <div class="game-title">Taxation <span>Challenge</span></div>
            <div class="stats-container">
                <div class="stat">
                    <div class="stat-label">TIME</div>
                    <div id="timer" class="stat-value">03:00</div>
                </div>
                <div class="stat">
                    <div class="stat-label">SCORE</div>
                    <div id="score" class="stat-value">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">LEVEL</div>
                    <div id="level" class="stat-value">1</div>
                </div>
                <div class="stat">
                    <div class="stat-label">STARS</div>
                    <div class="stars-container">
                        <div class="star"><i class="far fa-star"></i></div>
                        <div class="star"><i class="far fa-star"></i></div>
                        <div class="star"><i class="far fa-star"></i></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="game-content">
            <!-- Game Scenarios and Challenges -->
            <div id="gameArea">
                <div class="game-scenario">
                    <h2 class="scenario-title" id="scenarioTitle">Welcome to Taxation Challenge!</h2>
                    <p class="scenario-text" id="scenarioText">
                        In this game, you'll help various characters calculate their taxes, understand tax concepts, and make smart financial decisions. Complete all 3 levels before time runs out to earn the maximum stars!
                    </p>
                    <div class="tax-info" id="taxInfo">
                        <strong>Current Tax Info:</strong> Personal Relief: RM9,000 | Tax Rates: 0-5,000: 0%, 5,001-20,000: 1%, 20,001-35,000: 3%, 35,001-50,000: 8%
                    </div>
                    
                    <div class="formula-box" id="formulaBox">
                        <div class="formula-title">
                            <i class="fas fa-calculator"></i> Key Formula
                        </div>
                        <div class="formula-content" id="formulaContent">
                            <strong>Chargeable Income = Total Income - Reliefs</strong><br>
                            <strong>Income Tax = (Income in each band × Tax Rate for that band)</strong>
                        </div>
                    </div>
                    
                    <div class="hint-box" id="hintBox">
                        <div class="hint-title" id="hintToggle">
                            <i class="fas fa-lightbulb"></i> Hint (Click to show)
                        </div>
                        <div class="hint-content" id="hintContent">
                            <!-- Hint content will be inserted here -->
                        </div>
                    </div>
                </div>
                
                <div class="game-challenge" id="challengeArea">
                    <!-- Challenge cards will be inserted here by JavaScript -->
                </div>
                
                <div class="input-container" id="inputArea">
                    <!-- Input fields will be inserted here by JavaScript -->
                </div>
                
                <div class="feedback" id="feedback"></div>
                
                <div class="level-progress" id="levelProgress">
                    <!-- Level progress stars will be inserted here -->
                </div>
                
                <div class="buttons-container">
                    <button class="game-button" id="hintBtn">
                        <i class="fas fa-lightbulb"></i> Show Hint
                    </button>
                    <button class="game-button" id="submitBtn">
                        <i class="fas fa-check-circle"></i> Submit Answer
                    </button>
                    <button class="game-button" id="nextBtn">
                        <i class="fas fa-arrow-right"></i> Next Challenge
                    </button>
                    <button class="game-button" id="restartBtn">
                        <i class="fas fa-redo"></i> Restart Game
                    </button>
                </div>
            </div>
            
            <!-- Game Over Screen -->
            <div id="gameOver" class="game-over">
                <h2>Game Complete!</h2>
                <div class="final-score" id="finalScore">0</div>
                <div class="final-stars" id="finalStars">
                    <i class="far fa-star"></i>
                    <i class="far fa-star"></i>
                    <i class="far fa-star"></i>
                </div>
                <div class="level-progress" id="finalLevelProgress">
                    <!-- Final level stars will be inserted here -->
                </div>
                <p class="final-message" id="finalMessage">Well done! You've completed all levels of the Taxation Challenge.</p>
                <button class="game-button" id="restartEndBtn" style="margin: 30px auto 0; width: 250px;">
                    <i class="fas fa-redo"></i> Play Again
                </button>
            </div>
        </div>
    </div>

    <script>
        // Game variables
        let score = 0;
        let level = 1;
        let timeLeft = 180; // 3 minutes in seconds (increased from 2 minutes)
        let timerInterval;
        let stars = 0;
        let currentChallenge = 0;
        let gameActive = true;
        let hintUsed = false;
        
        // Track level completion and stars per level
        let levelStars = {1: 0, 2: 0, 3: 0};
        let levelCorrectAnswers = {1: 0, 2: 0, 3: 0};
        
        // Tax rates for different levels
        const taxRates = {
            1: [
                { min: 0, max: 5000, rate: 0 },
                { min: 5001, max: 20000, rate: 0.01 },
                { min: 20001, max: 35000, rate: 0.03 },
                { min: 35001, max: 50000, rate: 0.08 }
            ],
            2: [
                { min: 0, max: 5000, rate: 0 },
                { min: 5001, max: 20000, rate: 0.01 },
                { min: 20001, max: 35000, rate: 0.03 },
                { min: 35001, max: 50000, rate: 0.08 },
                { min: 50001, max: 70000, rate: 0.14 }
            ],
            3: [
                { min: 0, max: 5000, rate: 0 },
                { min: 5001, max: 20000, rate: 0.01 },
                { min: 20001, max: 35000, rate: 0.03 },
                { min: 35001, max: 50000, rate: 0.08 },
                { min: 50001, max: 70000, rate: 0.14 },
                { min: 70001, max: 100000, rate: 0.21 }
            ]
        };
        
        // Game challenges data with formulas and hints
        const challenges = [
            // Level 1 Challenges
            {
                level: 1,
                title: "Calculating Chargeable Income",
                scenario: "Ahmad earned RM45,000 this year. He has personal relief of RM9,000 and donates RM500 to charity. What is his chargeable income?",
                type: "calculation",
                answer: 35500,
                explanation: "Chargeable Income = Total Income - Reliefs - Donations = 45,000 - 9,000 - 500 = RM35,500",
                formula: "Chargeable Income = Total Income - Reliefs - Allowable Deductions",
                hint: "Step 1: Start with total income: RM45,000<br>Step 2: Subtract personal relief: 45,000 - 9,000 = RM36,000<br>Step 3: Subtract charity donation: 36,000 - 500 = RM35,500",
                options: [
                    { value: 35500, text: "RM35,500" },
                    { value: 36500, text: "RM36,500" },
                    { value: 44500, text: "RM44,500" },
                    { value: 45000, text: "RM45,000" }
                ]
            },
            {
                level: 1,
                title: "Identifying Tax Relief",
                scenario: "Which of the following is NOT eligible for tax relief in Malaysia?",
                type: "multiple-choice",
                answer: "vacation",
                explanation: "Vacation expenses are not eligible for tax relief. Eligible reliefs include EPF contributions, lifestyle expenses, and medical expenses.",
                formula: "Common Tax Reliefs in Malaysia:<br>• Personal Relief: RM9,000<br>• EPF Contributions: Up to RM4,000<br>• Lifestyle Expenses: Up to RM2,500<br>• Medical Expenses: For parents up to RM8,000",
                hint: "Think about what expenses the government encourages through tax relief. Vacation is a personal leisure expense, while EPF contributions, lifestyle expenses (books, sports equipment, etc.), and medical expenses are encouraged for social benefits.",
                options: [
                    { value: "epf", text: "EPF Contributions" },
                    { value: "lifestyle", text: "Lifestyle Expenses (up to RM2,500)" },
                    { value: "medical", text: "Medical Expenses for Parents" },
                    { value: "vacation", text: "Vacation Expenses" }
                ]
            },
            {
                level: 1,
                title: "Tax Calculation Challenge",
                scenario: "Siti has a chargeable income of RM28,000. Calculate her income tax based on the tax rates provided.",
                type: "calculation",
                answer: 340,
                explanation: "First RM5,000: 0% tax = RM0. Next RM15,000 (5,001-20,000): 1% = RM150. Remaining RM8,000 (20,001-28,000): 3% = RM240. Total Tax = 0 + 150 + 240 = RM340",
                formula: "Progressive Tax Calculation:<br>1. First RM5,000: 0% × 5,000 = RM0<br>2. Next RM15,000: 1% × 15,000 = RM150<br>3. Next RM15,000: 3% × amount in this band",
                hint: "Step 1: First RM5,000 is tax-free (0%) = RM0<br>Step 2: Next RM15,000 (from RM5,001 to RM20,000) at 1% = 15,000 × 0.01 = RM150<br>Step 3: Remaining RM8,000 (from RM20,001 to RM28,000) at 3% = 8,000 × 0.03 = RM240<br>Step 4: Total = 0 + 150 + 240 = RM340",
                options: [
                    { value: 280, text: "RM280" },
                    { value: 340, text: "RM340" },
                    { value: 420, text: "RM420" },
                    { value: 500, text: "RM500" }
                ]
            },
            // Level 2 Challenges
            {
                level: 2,
                title: "Multiple Income Sources",
                scenario: "David earns RM40,000 from his job and RM15,000 from freelance work. He has RM11,000 in tax reliefs. What is his chargeable income?",
                type: "calculation",
                answer: 44000,
                explanation: "Total Income = 40,000 + 15,000 = RM55,000. Chargeable Income = 55,000 - 11,000 = RM44,000",
                formula: "Total Income = Salary + Other Income<br>Chargeable Income = Total Income - Total Reliefs",
                hint: "Step 1: Calculate total income: RM40,000 (job) + RM15,000 (freelance) = RM55,000<br>Step 2: Subtract total reliefs: RM55,000 - RM11,000 = RM44,000",
                options: [
                    { value: 44000, text: "RM44,000" },
                    { value: 45000, text: "RM45,000" },
                    { value: 49000, text: "RM49,000" },
                    { value: 55000, text: "RM55,000" }
                ]
            },
            {
                level: 2,
                title: "Tax Rebate Eligibility",
                scenario: "Which taxpayer is eligible for a tax rebate of RM400?",
                type: "multiple-choice",
                answer: "single",
                explanation: "A single individual with chargeable income less than RM35,000 is eligible for a RM400 tax rebate.",
                formula: "Tax Rebate Rules:<br>• Single individual: RM400 if chargeable income ≤ RM35,000<br>• Married individuals: Different rules apply<br>• Rebate reduces final tax payable (not chargeable income)",
                hint: "A tax rebate of RM400 is given to single individuals with chargeable income of RM35,000 or less. It's like a discount on your final tax bill if you meet certain conditions.",
                options: [
                    { value: "single", text: "Single individual with chargeable income RM30,000" },
                    { value: "married", text: "Married couple with combined income RM80,000" },
                    { value: "business", text: "Business with annual profit RM100,000" },
                    { value: "retiree", text: "Retiree with pension RM25,000" }
                ]
            },
            {
                level: 2,
                title: "Complex Tax Calculation",
                scenario: "Emma has a chargeable income of RM62,000. Calculate her income tax based on the level 2 tax rates.",
                type: "calculation",
                answer: 2680,
                explanation: "First RM5,000: 0% = RM0. Next RM15,000: 1% = RM150. Next RM15,000: 3% = RM450. Next RM15,000: 8% = RM1,200. Remaining RM12,000: 14% = RM1,680. Total = 0+150+450+1200+1680 = RM2,680",
                formula: "Level 2 Tax Calculation:<br>1. 0-5,000: 0%<br>2. 5,001-20,000: 1%<br>3. 20,001-35,000: 3%<br>4. 35,001-50,000: 8%<br>5. 50,001-70,000: 14%",
                hint: "Step-by-step calculation:<br>1. First RM5,000: 0% = RM0<br>2. Next RM15,000 (5,001-20,000): 1% = 15,000 × 0.01 = RM150<br>3. Next RM15,000 (20,001-35,000): 3% = 15,000 × 0.03 = RM450<br>4. Next RM15,000 (35,001-50,000): 8% = 15,000 × 0.08 = RM1,200<br>5. Remaining RM12,000 (50,001-62,000): 14% = 12,000 × 0.14 = RM1,680<br>6. Total = 0 + 150 + 450 + 1,200 + 1,680 = RM2,680",
                options: [
                    { value: 2420, text: "RM2,420" },
                    { value: 2680, text: "RM2,680" },
                    { value: 2950, text: "RM2,950" },
                    { value: 3100, text: "RM3,100" }
                ]
            },
            // Level 3 Challenges
            {
                level: 3,
                title: "Tax Planning Challenge",
                scenario: "John's annual income is RM85,000. He can claim RM15,000 in reliefs. He plans to donate RM3,000 to reduce his tax. What's his final chargeable income?",
                type: "calculation",
                answer: 67000,
                explanation: "Chargeable Income = Total Income - Reliefs - Donations = 85,000 - 15,000 - 3,000 = RM67,000",
                formula: "Tax Planning Formula:<br>Chargeable Income = Total Income - Reliefs - Allowable Donations<br>Donations to approved institutions are tax deductible!",
                hint: "Step 1: Start with total income: RM85,000<br>Step 2: Subtract reliefs: 85,000 - 15,000 = RM70,000<br>Step 3: Subtract donations: 70,000 - 3,000 = RM67,000<br>Donations to approved institutions can reduce your chargeable income!",
                options: [
                    { value: 67000, text: "RM67,000" },
                    { value: 70000, text: "RM70,000" },
                    { value: 73000, text: "RM73,000" },
                    { value: 85000, text: "RM85,000" }
                ]
            },
            {
                level: 3,
                title: "Tax Avoidance vs Evasion",
                scenario: "Which of these is an example of legal tax avoidance (not evasion)?",
                type: "multiple-choice",
                answer: "epf",
                explanation: "Contributing more to EPF is legal tax avoidance. Underreporting income and fake receipts are tax evasion, which is illegal.",
                formula: "Tax Avoidance (Legal) vs Tax Evasion (Illegal):<br>• Avoidance: Using legal methods to minimize tax (EPF, donations)<br>• Evasion: Illegal methods to avoid paying tax (hiding income, fake receipts)",
                hint: "Tax avoidance is legal - using methods allowed by law to reduce taxes (like contributing to EPF). Tax evasion is illegal - deliberately not paying taxes you owe (like hiding income or creating fake receipts).",
                options: [
                    { value: "epf", text: "Contributing more to EPF to reduce chargeable income" },
                    { value: "underreport", text: "Underreporting business income" },
                    { value: "fake", text: "Creating fake receipts for deductions" },
                    { value: "offshore", text: "Hiding money in offshore accounts" }
                ]
            },
            {
                level: 3,
                title: "Advanced Tax Calculation",
                scenario: "Mr. Tan has a chargeable income of RM95,000. Calculate his income tax based on the level 3 tax rates.",
                type: "calculation",
                answer: 10050,
                explanation: "First RM5,000: 0% = RM0. Next RM15,000: 1% = RM150. Next RM15,000: 3% = RM450. Next RM15,000: 8% = RM1,200. Next RM20,000: 14% = RM2,800. Remaining RM25,000: 21% = RM5,250. Total = 0+150+450+1200+2800+5250 = RM10,050",
                formula: "Level 3 Tax Calculation:<br>1. 0-5,000: 0%<br>2. 5,001-20,000: 1%<br>3. 20,001-35,000: 3%<br>4. 35,001-50,000: 8%<br>5. 50,001-70,000: 14%<br>6. 70,001-100,000: 21%",
                hint: "Step-by-step calculation:<br>1. First RM5,000: 0% = RM0<br>2. Next RM15,000: 1% = 15,000 × 0.01 = RM150<br>3. Next RM15,000: 3% = 15,000 × 0.03 = RM450<br>4. Next RM15,000: 8% = 15,000 × 0.08 = RM1,200<br>5. Next RM20,000: 14% = 20,000 × 0.14 = RM2,800<br>6. Remaining RM25,000: 21% = 25,000 × 0.21 = RM5,250<br>7. Total = 0 + 150 + 450 + 1,200 + 2,800 + 5,250 = RM10,050",
                options: [
                    { value: 9250, text: "RM9,250" },
                    { value: 10050, text: "RM10,050" },
                    { value: 11200, text: "RM11,200" },
                    { value: 12000, text: "RM12,000" }
                ]
            }
        ];
        
        // DOM Elements
        const timerElement = document.getElementById('timer');
        const scoreElement = document.getElementById('score');
        const levelElement = document.getElementById('level');
        const starsElements = document.querySelectorAll('.star');
        const gameArea = document.getElementById('gameArea');
        const gameOverScreen = document.getElementById('gameOver');
        const scenarioTitle = document.getElementById('scenarioTitle');
        const scenarioText = document.getElementById('scenarioText');
        const taxInfo = document.getElementById('taxInfo');
        const formulaBox = document.getElementById('formulaBox');
        const formulaContent = document.getElementById('formulaContent');
        const hintBox = document.getElementById('hintBox');
        const hintToggle = document.getElementById('hintToggle');
        const hintContent = document.getElementById('hintContent');
        const challengeArea = document.getElementById('challengeArea');
        const inputArea = document.getElementById('inputArea');
        const feedbackElement = document.getElementById('feedback');
        const levelProgressElement = document.getElementById('levelProgress');
        const finalLevelProgressElement = document.getElementById('finalLevelProgress');
        const submitBtn = document.getElementById('submitBtn');
        const hintBtn = document.getElementById('hintBtn');
        const nextBtn = document.getElementById('nextBtn');
        const restartBtn = document.getElementById('restartBtn');
        const restartEndBtn = document.getElementById('restartEndBtn');
        const finalScoreElement = document.getElementById('finalScore');
        const finalStarsElement = document.getElementById('finalStars');
        const finalMessageElement = document.getElementById('finalMessage');
        
        // Initialize game
        function initGame() {
            score = 0;
            level = 1;
            timeLeft = 180; // 3 minutes
            stars = 0;
            currentChallenge = 0;
            gameActive = true;
            hintUsed = false;
            
            // Reset level tracking
            levelStars = {1: 0, 2: 0, 3: 0};
            levelCorrectAnswers = {1: 0, 2: 0, 3: 0};
            
            // Reset UI
            updateUI();
            gameArea.style.display = 'block';
            gameOverScreen.style.display = 'none';
            
            // Reset stars
            starsElements.forEach(star => {
                star.className = 'star';
                star.innerHTML = '<i class="far fa-star"></i>';
            });
            
            // Update level progress display
            updateLevelProgress();
            
            // Load first challenge
            loadChallenge(currentChallenge);
            
            // Start timer
            clearInterval(timerInterval);
            startTimer();
            
            // Update tax info
            updateTaxInfo();
        }
        
        // Update level progress display
        function updateLevelProgress() {
            levelProgressElement.innerHTML = '';
            
            for (let i = 1; i <= 3; i++) {
                const levelStar = document.createElement('div');
                levelStar.className = 'level-star';
                
                const starIcon = document.createElement('div');
                starIcon.className = 'star';
                starIcon.innerHTML = levelStars[i] >= 1 ? 
                    '<i class="fas fa-star" style="color:#f1c40f; font-size: 1.8rem;"></i>' : 
                    '<i class="far fa-star" style="font-size: 1.8rem;"></i>';
                
                const levelLabel = document.createElement('div');
                levelLabel.className = 'level-label';
                levelLabel.textContent = `Level ${i}`;
                
                levelStar.appendChild(starIcon);
                levelStar.appendChild(levelLabel);
                levelProgressElement.appendChild(levelStar);
            }
        }
        
        // Start the timer
        function startTimer() {
            timerInterval = setInterval(() => {
                if (timeLeft <= 0) {
                    endGame();
                    return;
                }
                
                timeLeft--;
                updateTimer();
                
                // Warning when time is running low
                if (timeLeft === 30) {
                    timerElement.style.color = '#e74c3c';
                }
            }, 1000);
        }
        
        // Update timer display
        function updateTimer() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // Update UI elements
        function updateUI() {
            scoreElement.textContent = score;
            levelElement.textContent = level;
            updateTimer();
        }
        
        // Update tax information display
        function updateTaxInfo() {
            const rates = taxRates[level];
            let infoText = `<strong>Level ${level} Tax Rates:</strong> `;
            
            rates.forEach((rate, index) => {
                infoText += `${rate.min.toLocaleString()}-${rate.max.toLocaleString()}: ${(rate.rate * 100)}%`;
                if (index < rates.length - 1) infoText += " | ";
            });
            
            taxInfo.innerHTML = infoText;
        }
        
        // Load a challenge
        function loadChallenge(index) {
            const challenge = challenges[index];
            hintUsed = false;
            
            // Update scenario
            scenarioTitle.textContent = `Level ${challenge.level} Challenge: ${challenge.title}`;
            scenarioText.textContent = challenge.scenario;
            
            // Update formula
            formulaContent.innerHTML = challenge.formula;
            
            // Update hint
            hintContent.innerHTML = challenge.hint;
            hintBox.style.display = 'none';
            hintToggle.innerHTML = '<i class="fas fa-lightbulb"></i> Hint (Click to show)';
            
            // Update level if needed
            if (challenge.level !== level) {
                level = challenge.level;
                levelElement.textContent = level;
                updateTaxInfo();
            }
            
            // Clear previous challenge
            challengeArea.innerHTML = '';
            inputArea.innerHTML = '';
            feedbackElement.className = 'feedback';
            feedbackElement.textContent = '';
            
            // Create challenge cards
            if (challenge.type === 'multiple-choice') {
                challenge.options.forEach(option => {
                    const card = document.createElement('div');
                    card.className = 'challenge-card';
                    card.dataset.value = option.value;
                    card.innerHTML = `
                        <div class="challenge-icon">
                            <i class="fas fa-question-circle"></i>
                        </div>
                        <h3 class="challenge-title">${option.text}</h3>
                    `;
                    
                    card.addEventListener('click', () => {
                        // Remove selection from all cards
                        document.querySelectorAll('.challenge-card').forEach(c => {
                            c.classList.remove('selected');
                        });
                        
                        // Select this card
                        card.classList.add('selected');
                    });
                    
                    challengeArea.appendChild(card);
                });
                
                // Hide input area for multiple choice
                inputArea.style.display = 'none';
            } else {
                // Show input area for calculations
                inputArea.style.display = 'block';
                inputArea.innerHTML = `
                    <div class="input-group">
                        <label for="taxAnswer">Enter your answer (RM):</label>
                        <input type="number" id="taxAnswer" placeholder="Enter amount in RM">
                    </div>
                `;
                
                // Show options as cards
                challenge.options.forEach(option => {
                    const card = document.createElement('div');
                    card.className = 'challenge-card';
                    card.dataset.value = option.value;
                    card.innerHTML = `
                        <div class="challenge-icon">
                            <i class="fas fa-calculator"></i>
                        </div>
                        <h3 class="challenge-title">${option.text}</h3>
                        <p class="challenge-description">Click to select this answer</p>
                    `;
                    
                    card.addEventListener('click', () => {
                        // Remove selection from all cards
                        document.querySelectorAll('.challenge-card').forEach(c => {
                            c.classList.remove('selected');
                        });
                        
                        // Select this card
                        card.classList.add('selected');
                        
                        // Also update the input field
                        document.getElementById('taxAnswer').value = option.value;
                    });
                    
                    challengeArea.appendChild(card);
                });
            }
            
            // Update buttons
            submitBtn.style.display = 'block';
            hintBtn.style.display = 'block';
            nextBtn.style.display = 'none';
        }
        
        // Show hint
        function showHint() {
            if (!hintUsed) {
                hintBox.style.display = 'block';
                hintToggle.innerHTML = '<i class="fas fa-lightbulb"></i> Hint';
                hintUsed = true;
                
                // Reduce points for using hint
                score = Math.max(0, score - 10);
                scoreElement.textContent = score;
            } else {
                // Toggle hint visibility
                if (hintBox.style.display === 'block') {
                    hintBox.style.display = 'none';
                    hintToggle.innerHTML = '<i class="fas fa-lightbulb"></i> Hint (Click to show)';
                } else {
                    hintBox.style.display = 'block';
                    hintToggle.innerHTML = '<i class="fas fa-lightbulb"></i> Hint';
                }
            }
        }
        
        // Check answer
        function checkAnswer() {
            const challenge = challenges[currentChallenge];
            let userAnswer;
            
            if (challenge.type === 'multiple-choice') {
                const selectedCard = document.querySelector('.challenge-card.selected');
                if (!selectedCard) {
                    feedbackElement.textContent = 'Please select an answer!';
                    feedbackElement.className = 'feedback incorrect';
                    feedbackElement.style.display = 'block';
                    return;
                }
                userAnswer = selectedCard.dataset.value;
            } else {
                const inputField = document.getElementById('taxAnswer');
                userAnswer = parseFloat(inputField.value);
                
                if (isNaN(userAnswer)) {
                    feedbackElement.textContent = 'Please enter a valid number!';
                    feedbackElement.className = 'feedback incorrect';
                    feedbackElement.style.display = 'block';
                    return;
                }
            }
            
            // Check if answer is correct
            const isCorrect = userAnswer == challenge.answer;
            
            // Update correct answers for this level
            if (isCorrect) {
                levelCorrectAnswers[challenge.level]++;
            }
            
            // Update UI based on correctness
            if (isCorrect) {
                // Add points (less if hint was used)
                let points = level * 100;
                if (hintUsed) {
                    points = Math.max(50, points - 50); // Reduced points if hint used
                }
                score += points;
                scoreElement.textContent = score;
                
                // Show correct feedback
                feedbackElement.textContent = `Correct! ${challenge.explanation}`;
                feedbackElement.className = 'feedback correct';
                
                // Mark selected card as correct
                const selectedCard = document.querySelector('.challenge-card.selected');
                if (selectedCard) {
                    selectedCard.classList.add('correct');
                }
            } else {
                // Show incorrect feedback
                feedbackElement.textContent = `Not quite right. ${challenge.explanation}`;
                feedbackElement.className = 'feedback incorrect';
                
                // Mark selected card as incorrect
                const selectedCard = document.querySelector('.challenge-card.selected');
                if (selectedCard) {
                    selectedCard.classList.add('incorrect');
                }
                
                // Mark correct card
                document.querySelectorAll('.challenge-card').forEach(card => {
                    if (card.dataset.value == challenge.answer) {
                        card.classList.add('correct');
                    }
                });
            }
            
            // Show feedback
            feedbackElement.style.display = 'block';
            
            // Update buttons
            submitBtn.style.display = 'none';
            hintBtn.style.display = 'none';
            nextBtn.style.display = 'block';
            
            // Check if level is complete and update stars
            updateLevelStars(challenge.level);
            
            // Check if this was the last challenge
            if (currentChallenge >= challenges.length - 1) {
                nextBtn.innerHTML = '<i class="fas fa-flag-checkered"></i> Finish Game';
            }
        }
        
        // Update stars for a level
        function updateLevelStars(currentLevel) {
            // Check how many challenges in this level have been completed
            const levelChallenges = challenges.filter(c => c.level === currentLevel);
            const totalInLevel = levelChallenges.length;
            
            // Find the current challenge index within the level
            const levelStartIndex = challenges.findIndex(c => c.level === currentLevel);
            const levelPosition = currentChallenge - levelStartIndex + 1;
            
            // Calculate percentage of level completed
            if (levelPosition === totalInLevel) {
                // Level is complete, calculate stars based on performance
                const correctCount = levelCorrectAnswers[currentLevel];
                const percentage = correctCount / totalInLevel;
                
                if (percentage === 1) {
                    levelStars[currentLevel] = 3; // Perfect score = 3 stars
                } else if (percentage >= 0.66) {
                    levelStars[currentLevel] = 2; // Good score = 2 stars
                } else if (percentage >= 0.33) {
                    levelStars[currentLevel] = 1; // Minimum to pass = 1 star
                }
                
                // Update level progress display
                updateLevelProgress();
                
                // Update total stars in header
                updateTotalStars();
            }
        }
        
        // Update total stars in header
        function updateTotalStars() {
            // Calculate total stars from all levels
            const totalStars = levelStars[1] + levelStars[2] + levelStars[3];
            
            // Update star display in header
            starsElements.forEach((star, index) => {
                if (index < totalStars) {
                    star.className = 'star filled';
                    star.innerHTML = '<i class="fas fa-star"></i>';
                } else {
                    star.className = 'star';
                    star.innerHTML = '<i class="far fa-star"></i>';
                }
            });
        }
        
        // Move to next challenge
        function nextChallenge() {
            currentChallenge++;
            
            if (currentChallenge >= challenges.length) {
                endGame();
                return;
            }
            
            loadChallenge(currentChallenge);
        }
        
        // End the game
        function endGame() {
            gameActive = false;
            clearInterval(timerInterval);
            
            // Calculate final total stars
            const totalStars = levelStars[1] + levelStars[2] + levelStars[3];
            
            // Update final score display
            finalScoreElement.textContent = score;
            
            // Update final stars display
            finalStarsElement.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                const star = document.createElement('i');
                star.className = i < totalStars ? 'fas fa-star' : 'far fa-star';
                finalStarsElement.appendChild(star);
            }
            
            // Update final level progress
            finalLevelProgressElement.innerHTML = '';
            for (let i = 1; i <= 3; i++) {
                const levelStar = document.createElement('div');
                levelStar.className = 'level-star';
                
                const starIcon = document.createElement('div');
                starIcon.className = 'star';
                starIcon.innerHTML = levelStars[i] >= 1 ? 
                    '<i class="fas fa-star" style="color:#f1c40f; font-size: 1.8rem;"></i>' : 
                    '<i class="far fa-star" style="font-size: 1.8rem;"></i>';
                
                const levelLabel = document.createElement('div');
                levelLabel.className = 'level-label';
                levelLabel.textContent = `Level ${i}`;
                
                levelStar.appendChild(starIcon);
                levelStar.appendChild(levelLabel);
                finalLevelProgressElement.appendChild(levelStar);
            }
            
            // Update final message
            let message = '';
            if (totalStars === 9) {
                message = "Perfect score! You're a taxation expert! You've mastered all levels with maximum stars.";
            } else if (totalStars >= 6) {
                message = "Excellent job! You have a strong understanding of taxation concepts.";
            } else if (totalStars >= 3) {
                message = "Good work! You have a solid foundation in taxation. Keep practicing to earn more stars!";
            } else {
                message = "You've completed the game! Review the taxation concepts and try again to earn more stars.";
            }
            
            finalMessageElement.textContent = message;
            
            // Show game over screen
            gameArea.style.display = 'none';
            gameOverScreen.style.display = 'block';
        }
        
        // Event Listeners
        submitBtn.addEventListener('click', checkAnswer);
        hintBtn.addEventListener('click', showHint);
        hintToggle.addEventListener('click', showHint);
        nextBtn.addEventListener('click', nextChallenge);
        restartBtn.addEventListener('click', initGame);
        restartEndBtn.addEventListener('click', initGame);
        
        // Initialize the game when page loads
        window.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>