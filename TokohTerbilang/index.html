<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pertahanan Melaka: EDISI PRO</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Roboto:wght@400;700&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(to bottom, #1E90FF, #87CEEB);
            user-select: none;
        }

        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
        }

        /* Top Bar */
        .top-bar { display: flex; justify-content: space-between; align-items: flex-start; }

        .stats-box {
            background: rgba(255, 255, 255, 0.95);
            border: 4px solid #4a2c20;
            border-radius: 15px;
            padding: 10px 25px;
            box-shadow: 0 6px 0 rgba(0,0,0,0.2);
            font-family: 'Fredoka One', cursive;
            color: #4a2c20;
            min-width: 150px;
        }

        .stat-item { font-size: 1.3rem; margin-bottom: 5px; }
        .combo-text { color: #FF4500; font-size: 1.1rem; display: none; }
        .powerup-text { color: #00BFFF; font-size: 1.1rem; display: none; font-weight: bold; animation: blink 0.5s infinite alternate; }

        @keyframes blink { from { opacity: 1; } to { opacity: 0.5; } }

        #btn-translate {
            pointer-events: auto;
            background: #FFD700;
            border: 4px solid #DAA520;
            border-radius: 12px;
            padding: 10px 20px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 0 #B8860B;
            font-family: 'Fredoka One', cursive;
            transition: transform 0.1s;
        }
        #btn-translate:active { transform: translateY(4px); box-shadow: 0 0 0 #B8860B; }

        /* Mission Panel */
        #mission-panel {
            pointer-events: auto;
            background: #fff8dc;
            border: 4px solid #8B4513;
            border-radius: 15px;
            padding: 15px 30px;
            max-width: 600px;
            margin: 0 auto;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            position: absolute;
            top: 80px; left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }

        #mission-title { font-weight: bold; color: #8B4513; font-size: 0.9rem; letter-spacing: 2px; margin-bottom: 5px; }
        #question-text { font-size: 1.4rem; font-weight: 800; color: #222; margin-bottom: 8px; line-height: 1.3; }
        #hint-text { font-size: 1rem; color: #006400; background: #98FB98; padding: 4px 10px; border-radius: 5px; display: inline-block; font-weight: bold; }

        canvas { display: block; width: 100%; height: 100%; }

        /* End Screen */
        #end-screen {
            display: none;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            justify-content: center;
            align-items: center;
            flex-direction: column;
            pointer-events: auto;
            z-index: 100;
            backdrop-filter: blur(5px);
        }

        .end-card {
            background: linear-gradient(135deg, #fff, #f0f0f0);
            padding: 40px;
            border-radius: 25px;
            text-align: center;
            border: 6px solid #FF8C00;
            box-shadow: 0 0 50px rgba(255, 140, 0, 0.5);
            animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-family: 'Fredoka One', cursive;
        }

        .stars { font-size: 4rem; color: #FFD700; margin: 15px 0; text-shadow: 3px 3px 0 #000; letter-spacing: 10px; }
        h1 { margin: 0; font-size: 3rem; color: #8B4513; }
        
        button.restart-btn {
            background: #32CD32;
            border: none;
            padding: 15px 40px;
            font-size: 1.5rem;
            color: white;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Fredoka One', cursive;
            margin-top: 20px;
            box-shadow: 0 6px 0 #228B22;
            transition: 0.1s;
        }
        button.restart-btn:active { transform: translateY(6px); box-shadow: none; }

        /* Effects */
        .shake { animation: shake 0.5s; }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="top-bar">
            <div class="stats-box">
                <div class="stat-item"><span id="lbl-score">Skor:</span> <span id="score-val">0</span></div>
                <div class="stat-item"><span id="lbl-time">Masa:</span> <span id="time-val">90</span>s</div>
                <div class="combo-text" id="combo-display">COMBO x2!</div>
                <div class="powerup-text" id="powerup-display">âš¡ RAPID FIRE âš¡</div>
            </div>
            
            <button id="btn-translate" onclick="toggleLanguage()">
                ðŸ‡ºðŸ‡¸ ENG / ðŸ‡²ðŸ‡¾ BM
            </button>
        </div>

        <div id="mission-panel">
            <div id="mission-title">MISI UTAMA</div>
            <div id="question-text">Loading...</div>
            <div id="hint-text">Hint...</div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="end-screen">
        <div class="end-card">
            <h1 id="end-title">TAMAT!</h1>
            <div class="stars" id="end-stars">â˜… â˜… â˜…</div>
            <p style="font-size: 1.5rem; color:#555;"><span id="lbl-final-score">Markah:</span> <span id="end-score">0</span></p>
            <button class="restart-btn" onclick="restartGame()" id="btn-restart">MAIN SEMULA</button>
        </div>
    </div>

    <script>
        // --- GAME CONTENT ---
        const gameContent = [
            { id: 1, ms: { q: "Pengasas Kesultanan Melayu Melaka?", h: "Putera dari Palembang.", ans: "Parameswara" }, en: { q: "Founder of Malacca Sultanate?", h: "Prince from Palembang.", ans: "Parameswara" }, distractors: ["Hang Tuah", "Tun Perak", "Sultan Mansur", "Bendahara"] },
            { id: 2, ms: { q: "Bendahara Melaka yang paling bijaksana?", h: "Berkhidmat 4 Sultan.", ans: "Tun Perak" }, en: { q: "Most wise Bendahara of Malacca?", h: "Served 4 Sultans.", ans: "Tun Perak" }, distractors: ["Hang Jebat", "Sultan Alauddin", "Parameswara", "Temenggung"] },
            { id: 3, ms: { q: "Laksamana yang terbilang?", h: "Pahlawan terhebat Melaka.", ans: "Hang Tuah" }, en: { q: "The renowned Admiral?", h: "Malacca's greatest warrior.", ans: "Hang Tuah" }, distractors: ["Tun Perak", "Sultan Muzaffar", "Tun Kudu", "Hang Lekir"] },
            { id: 4, ms: { q: "Pencipta Hukum Kanun Melaka?", h: "Menjadikan Islam agama rasmi.", ans: "Sultan Muzaffar" }, en: { q: "Creator of Hukum Kanun Melaka?", h: "Made Islam official religion.", ans: "Sultan Muzaffar" }, distractors: ["Hang Kasturi", "Tun Mutahir", "Parameswara", "Sultan Mahmud"] },
            { id: 5, ms: { q: "Sultan yang menjaga keselamatan malam?", h: "Menyamar untuk meronda.", ans: "Sultan Alauddin" }, en: { q: "Sultan who guarded the night?", h: "Disguised on patrol.", ans: "Sultan Alauddin" }, distractors: ["Tun Perak", "Hang Tuah", "Sultan Mansur", "Bendahara"] }
        ];

        const uiText = {
            ms: { score: "Skor:", time: "Masa:", mission: "MISI UTAMA", endTitle: "TAMAT!", finalScore: "Markah Akhir:", restart: "MAIN SEMULA" },
            en: { score: "Score:", time: "Time:", mission: "MAIN MISSION", endTitle: "GAME OVER!", finalScore: "Final Score:", restart: "PLAY AGAIN" }
        };

        // --- SETUP ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;

        // Game State
        let isGameRunning = false;
        let score = 0;
        let timeLeft = 90;
        let currentLang = 'ms';
        let combo = 0;
        let rapidFireActive = false;
        let rapidFireTimer = 0;
        let shakeTime = 0;

        // Question State
        let currentQIndex = 0;
        let currentQ = null;

        // Entities
        let cannon = { x: 0, y: 0, angle: -Math.PI/2 };
        let projectiles = [];
        let targets = [];
        let obstacles = []; // Rocks
        let particles = [];
        
        // Timers
        let lastTime = 0;
        let spawnTimer = 0;
        let obstacleTimer = 0;

        // --- INPUT ---
        let mouseX = 0, mouseY = 0;
        window.addEventListener('resize', resize);
        window.addEventListener('mousemove', e => { mouseX = e.clientX; mouseY = e.clientY; });
        window.addEventListener('mousedown', e => {
            if(e.target.id !== 'btn-translate' && isGameRunning) shoot();
        });

        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
            cannon.x = width / 2;
            cannon.y = height - 60;
        }
        resize();

        // --- CORE FUNCTIONS ---

        function startGame() {
            score = 0;
            timeLeft = 90;
            combo = 0;
            projectiles = [];
            targets = [];
            obstacles = [];
            particles = [];
            isGameRunning = true;
            rapidFireActive = false;
            
            document.getElementById('end-screen').style.display = 'none';
            document.body.classList.remove('shake');
            
            setQuestion();
            updateUI();
            
            // Timer
            const gameTimer = setInterval(() => {
                if(!isGameRunning) { clearInterval(gameTimer); return; }
                timeLeft--;
                updateUI();
                if(timeLeft <= 0) endGame();
            }, 1000);

            requestAnimationFrame(gameLoop);
        }

        function setQuestion() {
            currentQIndex = Math.floor(Math.random() * gameContent.length);
            currentQ = gameContent[currentQIndex];
            updateUIText();
        }

        function shoot() {
            const dx = mouseX - cannon.x;
            const dy = mouseY - cannon.y;
            const angle = Math.atan2(dy, dx);
            
            // Fire cooldown check
            if (!rapidFireActive && projectiles.length > 5) return; 

            const speed = rapidFireActive ? 25 : 15;
            const color = rapidFireActive ? '#00BFFF' : '#333';

            projectiles.push({
                x: cannon.x, y: cannon.y,
                vx: Math.cos(angle) * speed,
                vy: Math.sin(angle) * speed,
                radius: rapidFireActive ? 6 : 8,
                color: color
            });

            // Recoil effect
            cannon.y += 5;
        }

        function spawnEntity() {
            const margin = 50;
            const spawnX = Math.random() * (width - margin*2) + margin;
            
            // 5% chance for Power Up
            if (Math.random() < 0.05) {
                targets.push({
                    x: spawnX, initialX: spawnX, y: -50,
                    radius: 25, speed: 2,
                    text: "âš¡", type: "powerup",
                    color: "#00BFFF", swayOffset: Math.random() * 10
                });
                return;
            }

            // Normal Target
            const isCorrect = Math.random() > 0.6; 
            let text = isCorrect ? currentQ[currentLang].ans : currentQ.distractors[Math.floor(Math.random()*currentQ.distractors.length)];
            
            targets.push({
                x: spawnX,
                initialX: spawnX,
                y: -50,
                radius: 40,
                speed: 1.5 + (Math.random() * 1), // Variable speed
                text: text,
                type: isCorrect ? "correct" : "wrong",
                color: isCorrect ? "#32CD32" : "#FF6347",
                swayOffset: Math.random() * 100
            });
        }

        function spawnObstacle() {
            // Floating Rocks
            let isLeft = Math.random() > 0.5;
            obstacles.push({
                x: isLeft ? -60 : width + 60,
                y: Math.random() * (height/2) + 50,
                radius: 30 + Math.random() * 20,
                vx: isLeft ? 1.5 : -1.5,
                color: "#808080"
            });
        }

        function triggerShake() {
            const body = document.body;
            body.classList.remove('shake');
            void body.offsetWidth; // trigger reflow
            body.classList.add('shake');
        }

        // --- LOOP ---
        function gameLoop(timestamp) {
            if (!isGameRunning) return;
            
            ctx.clearRect(0, 0, width, height);

            // Background Cannon reset
            cannon.y += (height - 60 - cannon.y) * 0.1;

            // Spawners
            if (timestamp - spawnTimer > (rapidFireActive ? 400 : 1800)) {
                spawnEntity();
                spawnTimer = timestamp;
            }
            if (timestamp - obstacleTimer > 3500) {
                spawnObstacle();
                obstacleTimer = timestamp;
            }

            // Rapid Fire Logic
            if (rapidFireActive) {
                if (timestamp > rapidFireTimer) {
                    rapidFireActive = false;
                    document.getElementById('powerup-display').style.display = 'none';
                }
            }

            // --- DRAW & UPDATE ---

            // 1. Obstacles (Rocks)
            for (let i = obstacles.length - 1; i >= 0; i--) {
                let o = obstacles[i];
                o.x += o.vx;
                
                // Draw Rock
                ctx.beginPath();
                ctx.arc(o.x, o.y, o.radius, 0, Math.PI*2);
                ctx.fillStyle = "#696969";
                ctx.fill();
                // Rock shine
                ctx.beginPath();
                ctx.arc(o.x - o.radius/3, o.y - o.radius/3, o.radius/4, 0, Math.PI*2);
                ctx.fillStyle = "#A9A9A9";
                ctx.fill();

                if (o.x < -100 || o.x > width + 100) obstacles.splice(i, 1);
            }

            // 2. Targets (Bubbles)
            for (let i = targets.length - 1; i >= 0; i--) {
                let t = targets[i];
                t.y += t.speed;
                // ZIG ZAG MOVEMENT (Harder!)
                t.x = t.initialX + Math.sin((t.y + t.swayOffset) * 0.02) * 60; 

                // Draw Bubble
                ctx.beginPath();
                ctx.arc(t.x, t.y, t.radius, 0, Math.PI*2);
                ctx.fillStyle = t.color;
                ctx.fill();
                
                // Shine
                ctx.beginPath();
                ctx.arc(t.x - 10, t.y - 10, 8, 0, Math.PI*2);
                ctx.fillStyle = "rgba(255,255,255,0.3)";
                ctx.fill();

                // Border
                ctx.strokeStyle = "#fff";
                ctx.lineWidth = 3;
                ctx.stroke();

                // Text
                ctx.fillStyle = "white";
                ctx.font = "bold " + (t.type === 'powerup' ? '24px' : '15px') + " Roboto";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(t.text, t.x, t.y);

                // Collision with Projectile
                for (let j = projectiles.length - 1; j >= 0; j--) {
                    let p = projectiles[j];
                    let dist = Math.hypot(p.x - t.x, p.y - t.y);
                    
                    if (dist < t.radius + p.radius) {
                        createExplosion(t.x, t.y, t.color);
                        projectiles.splice(j, 1);
                        targets.splice(i, 1);

                        // Logic
                        if (t.type === 'powerup') {
                            rapidFireActive = true;
                            rapidFireTimer = timestamp + 5000; // 5 seconds
                            document.getElementById('powerup-display').style.display = 'block';
                        } else if (t.type === 'correct') {
                            combo++;
                            let multiplier = Math.min(combo, 5); // Max x5
                            score += 10 * multiplier;
                            setQuestion();
                        } else {
                            // Wrong hit
                            combo = 0;
                            score -= 10;
                            timeLeft -= 2; // Time penalty!
                            triggerShake();
                        }
                        updateUI();
                        break;
                    }
                }

                if (t.y > height + 50 && i < targets.length) targets.splice(i, 1);
            }

            // 3. Projectiles
            for (let i = projectiles.length - 1; i >= 0; i--) {
                let p = projectiles[i];
                p.x += p.vx;
                p.y += p.vy;
                
                // Draw
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.radius, 0, Math.PI*2);
                ctx.fillStyle = p.color || "#333";
                ctx.fill();

                // Hit Rock?
                for(let o of obstacles) {
                    if (Math.hypot(p.x - o.x, p.y - o.y) < o.radius + p.radius) {
                        projectiles.splice(i, 1); // Bullet destroyed
                        createExplosion(p.x, p.y, "#888"); // Small spark
                        break;
                    }
                }

                if (p.x < 0 || p.x > width || p.y < 0 || p.y > height) {
                    if(projectiles[i]) projectiles.splice(i, 1);
                }
            }

            // 4. Cannon
            const dx = mouseX - cannon.x;
            const dy = mouseY - cannon.y;
            const angle = Math.atan2(dy, dx);
            ctx.save();
            ctx.translate(cannon.x, cannon.y);
            ctx.rotate(angle);
            ctx.fillStyle = "#444";
            ctx.fillRect(0, -15, 60, 30);
            ctx.beginPath();
            ctx.arc(0, 0, 30, 0, Math.PI*2);
            ctx.fillStyle = "#222";
            ctx.fill();
            ctx.restore();

            // 5. Particles
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.x += p.vx; p.y += p.vy; p.life -= 0.05;
                if(p.life <= 0) particles.splice(i,1);
                else {
                    ctx.globalAlpha = p.life;
                    ctx.fillStyle = p.color;
                    ctx.beginPath(); ctx.arc(p.x, p.y, Math.random()*5, 0, Math.PI*2); ctx.fill();
                    ctx.globalAlpha = 1;
                }
            }

            requestAnimationFrame(gameLoop);
        }

        function createExplosion(x, y, color) {
            for(let k=0; k<15; k++) {
                particles.push({
                    x: x, y: y,
                    vx: (Math.random()-0.5)*12,
                    vy: (Math.random()-0.5)*12,
                    life: 1, color: color
                });
            }
        }

        // --- UI UPDATES ---

        function toggleLanguage() {
            currentLang = currentLang === 'ms' ? 'en' : 'ms';
            updateUIText();
        }

        function updateUIText() {
            const t = uiText[currentLang];
            document.getElementById('lbl-score').innerText = t.score;
            document.getElementById('lbl-time').innerText = t.time;
            document.getElementById('mission-title').innerText = t.mission;
            document.getElementById('end-title').innerText = t.endTitle;
            document.getElementById('lbl-final-score').innerText = t.finalScore;
            document.getElementById('btn-restart').innerText = t.restart;
            if(currentQ) {
                document.getElementById('question-text').innerText = currentQ[currentLang].q;
                document.getElementById('hint-text').innerText = "Hint: " + currentQ[currentLang].h;
            }
        }

        function updateUI() {
            document.getElementById('score-val').innerText = score;
            document.getElementById('time-val').innerText = timeLeft;
            
            // Combo Display
            const comboEl = document.getElementById('combo-display');
            if(combo > 1) {
                comboEl.style.display = 'block';
                comboEl.innerText = "COMBO x" + Math.min(combo, 5) + "!";
            } else {
                comboEl.style.display = 'none';
            }
        }

        function endGame() {
            isGameRunning = false;
            document.getElementById('end-screen').style.display = 'flex';
            document.getElementById('end-score').innerText = score;
            let s = "â˜† â˜† â˜†";
            if(score > 300) s = "â˜… â˜… â˜…";
            else if(score > 150) s = "â˜… â˜… â˜†";
            else if(score > 50) s = "â˜… â˜† â˜†";
            document.getElementById('end-stars').innerText = s;
        }

        function restartGame() {
            startGame();
        }

        // Start
        startGame();

    </script>
</body>
</html>